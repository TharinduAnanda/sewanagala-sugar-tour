import PDFDocument from 'pdfkit'
import { BookingEmailData } from './emailService'

interface PDFOptions {
  booking: BookingEmailData
}

export async function generateBookingPDF(booking: BookingEmailData): Promise<Buffer> {
  return new Promise((resolve, reject) => {
    try {
      const doc = new PDFDocument({
        size: 'A4',
        margins: { top: 50, bottom: 50, left: 50, right: 50 }
      })

      const buffers: Buffer[] = []
      
      doc.on('data', buffers.push.bind(buffers))
      doc.on('end', () => {
        const pdfBuffer = Buffer.concat(buffers)
        resolve(pdfBuffer)
      })
      doc.on('error', reject)

      // Colors matching your theme
      const primaryGreen = '#2c5f2d'
      const lightGreen = '#97bc62'
      const darkGray = '#333333'
      const lightGray = '#666666'
      const bgGray = '#f8f9fa'

      // Header with gradient effect
      doc.rect(0, 0, doc.page.width, 120)
         .fillColor(primaryGreen)
         .fill()

      // Company name
      doc.fillColor('#ffffff')
         .fontSize(28)
         .font('Helvetica-Bold')
         .text('SEWANAGALA SUGAR FACTORY', 50, 30, { align: 'center' })
      
      doc.fontSize(14)
         .font('Helvetica')
         .text('Tour Booking Confirmation', 50, 70, { align: 'center' })

      // Booking reference box
      doc.rect(50, 150, doc.page.width - 100, 80)
         .fillColor(bgGray)
         .fill()
      
      doc.rect(50, 150, 4, 80)
         .fillColor(primaryGreen)
         .fill()

      doc.fillColor(lightGray)
         .fontSize(10)
         .font('Helvetica')
         .text('BOOKING REFERENCE NUMBER', 65, 165)

      doc.fillColor(primaryGreen)
         .fontSize(24)
         .font('Helvetica-Bold')
         .text(booking.booking_id, 65, 185)

      doc.fillColor(lightGray)
         .fontSize(9)
         .text('Please keep this reference for your records', 65, 213)

      // Customer details section
      let yPos = 260

      doc.fillColor(primaryGreen)
         .fontSize(16)
         .font('Helvetica-Bold')
         .text('Booking Details', 50, yPos)

      yPos += 30

      // Details table
      const details = [
        { label: 'Name', value: booking.name },
        { label: 'Email', value: booking.email },
        { label: 'Phone', value: booking.phone },
        { label: 'Tour Date', value: new Date(booking.visit_date).toLocaleDateString('en-US', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        })},
        { label: 'Tour Time', value: booking.visit_time },
        { label: 'Number of Visitors', value: booking.visitor_count.toString() },
        { label: 'Booking Date', value: new Date(booking.booking_date).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        })},
        { label: 'Status', value: 'CONFIRMED', highlight: true }
      ]

      details.forEach((detail, index) => {
        // Alternating background
        if (index % 2 === 0) {
          doc.rect(50, yPos - 5, doc.page.width - 100, 30)
             .fillColor('#fafafa')
             .fill()
        }

        doc.fillColor(primaryGreen)
           .fontSize(11)
           .font('Helvetica-Bold')
           .text(detail.label, 60, yPos)

        if (detail.highlight) {
          doc.fillColor(primaryGreen)
             .fontSize(12)
             .font('Helvetica-Bold')
             .text(detail.value, 250, yPos)
        } else {
          doc.fillColor(darkGray)
             .fontSize(11)
             .font('Helvetica')
             .text(detail.value, 250, yPos)
        }

        yPos += 30
      })

      // Important instructions section
      yPos += 20

      doc.rect(50, yPos, doc.page.width - 100, 180)
         .fillColor('#e8f5e9')
         .fill()

      yPos += 15

      doc.fillColor(primaryGreen)
         .fontSize(14)
         .font('Helvetica-Bold')
         .text('ðŸ“‹ Important Instructions', 60, yPos)

      yPos += 25

      const instructions = [
        'Arrive 15 minutes before your scheduled time',
        'Bring a valid ID for check-in',
        'Wear comfortable walking shoes and modest clothing',
        'Photography is allowed in designated areas',
        'Tour duration is approximately 2 hours',
        'The tour includes safety briefing and factory floor access'
      ]

      instructions.forEach((instruction) => {
        doc.fillColor(darkGray)
           .fontSize(10)
           .font('Helvetica')
           .text('âœ“', 60, yPos, { continued: true })
           .text(`  ${instruction}`, 70, yPos)
        yPos += 22
      })

      // Contact information
      yPos += 20

      doc.rect(50, yPos, doc.page.width - 100, 90)
         .fillColor(bgGray)
         .fill()

      yPos += 15

      doc.fillColor(primaryGreen)
         .fontSize(12)
         .font('Helvetica-Bold')
         .text('Need to Make Changes?', 60, yPos, { align: 'center', width: doc.page.width - 120 })

      yPos += 25

      doc.fillColor(darkGray)
         .fontSize(10)
         .font('Helvetica')
         .text('Phone: +94 77 123 4567', 60, yPos, { align: 'center', width: doc.page.width - 120 })

      yPos += 15

      doc.text('Email: tours@sewanagalafactory.com', 60, yPos, { align: 'center', width: doc.page.width - 120 })

      yPos += 15

      doc.text('Office Hours: Mon-Fri, 8:00 AM - 5:00 PM', 60, yPos, { align: 'center', width: doc.page.width - 120 })

      // Footer
      const footerY = doc.page.height - 80

      doc.rect(0, footerY - 20, doc.page.width, 1)
         .fillColor('#e0e0e0')
         .fill()

      doc.fillColor(lightGray)
         .fontSize(10)
         .font('Helvetica-Bold')
         .text('Sewanagala Sugar Factory', 50, footerY, { align: 'center', width: doc.page.width - 100 })

      doc.fontSize(9)
         .font('Helvetica')
         .text('Proudly serving Sri Lanka since 1986', 50, footerY + 15, { align: 'center', width: doc.page.width - 100 })

      doc.fontSize(8)
         .text('Buttala Road, Sewanagala, Sri Lanka', 50, footerY + 30, { align: 'center', width: doc.page.width - 100 })

      // QR Code placeholder (you can add actual QR code generation if needed)
      doc.rect(doc.page.width - 100, footerY - 10, 50, 50)
         .stroke()

      doc.fontSize(7)
         .text('QR Code', doc.page.width - 95, footerY + 45)

      // Finalize PDF
      doc.end()
    } catch (error) {
      reject(error)
    }
  })
}

// Send PDF as email attachment
export async function sendBookingPDFEmail(booking: BookingEmailData, pdfBuffer: Buffer) {
  // This would integrate with your email service
  // For now, just return the buffer
  return pdfBuffer
}
